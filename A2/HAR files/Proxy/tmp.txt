async=require 'async'
# Total number of tcp connections to each domain and details of each connection
tcp_connections={}
fun5 = ->
	arr = data.log.entries
	async.map(arr, (entry,cb)->
		domain_name=entry.request.headers[0].value
		console.log(domain_name)
		ip=entry.serverIPAddress
		lines=[]
		if not tcp_connections[domain_name]?
			tcp_connections[domain_name]={"number_tcp_connection":0,"connections":[],"urls":[]}
			filter = "ip.dst==#{ip} && http"
			cmd = spawn 'tshark' , ['-r','nytimes.pcap','-Y',filter,'-T','fields','-e','ip.src','-e','ip.dst','-e' ,'tcp.port','-e','_ws.col.Info','-e','frame.number']
			cmd.stdout.on 'data' , (data) ->
				lines=console.log data.toString().split('\r\n')
				console.log(lines)
				tcp_connections[domain_name]["number_tcp_connection"]=lines.length;
				fields=[]
				for line in lines
					fields=line.split('\t')
					tcp_connections[domain_name]["connections"].push = fields[2];
					tcp_connections[domain_name]["url"].push = fields[4].split(' ')[1];
				cb(null,false)
	,(err,res)->
		console.log(tcp_connections)
	);